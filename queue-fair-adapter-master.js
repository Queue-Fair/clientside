"use-strict";

function defineQueueFair() {
	window.QueueFair = class {

		s="?gly#lg@%ti{|wkv6;<7:%#vw|ohĊdoo=ćqlwlĠ#$lpsruwdqw>#ĮvĦlrqģil{hgĪĬĮİĲĴ#erwwrpģ8s{ŃĭįıĳĵĝiwŐŒŔŅŗň}0lqgh{ģ54Ė7;69ĖşŖŇĵŊuŧu0udĄxvģ7ŞīŕņŘŉįŹģ&Fƍ#4ŞvroĈųƆňsŽĄqjģ3ƃńŴƇedfnjurxŦģzkĦhƖšŶr{0vkŽrzģujƤ+83/#ǂǄǆ#317,ǉŞőœ4ǐǎœƄŠŵĶrťwhźhyhĳƀ#qĻƱǖƢňrƙfĦ|ƞƲŇ%A?dęěĝğġģťĹĩǨƗĵĄvsodǯĤƔqh0iĝǕơȁ#ĠljqŤǜpǣfǡǜuǱƇfxuƒuģĮǛǝȠƘǚĳǝ0ǟȝǣťkǝĦȫĘkuhiĊkŌsƀ22txhɆȍdlu1fŎ2yɋwxĠ0zɊħƜŻrŎĘıƾhwĊbeȆqnǳ?vyj#zĈĐĊ55<ǋ9ŒȹhȕȿĊ45618;ɸ#ɑhzEƵĊ3ǉ#ɳɵ79Əɿʁ;ĘǠȤĺqɽ14Ę{poqvȾɀ=Ƀzʩ1zʀįj253ʲ2ɫjʟʡʣ=ʵʥwsʧ2ʩzʫʭƾʰʲ3ʴɬĘĚĜĞ%ĠĢĤǾoȫĵɯgĐŐƟȐƅƳ#ȵɻŜ#6˛˕ĶƚťƝǔǅƠ˝ǘȢȤįǼqȵuȷȀ˞ȨȮǞǠǢ˳˵˷ȑšĘA#ăȼv̅?fƔsSdĐ#̌l̎̐kXĥwʤ%ſǝVǬhRqXvhĘĈĊČfs8:<3ǳ̆ƙ̑ĉ%pʎ4Ǌ8/ů1:ʒfʎɵ3̻0ʀ36ǅ;̾:/716:#;51;;/ʱ͖≮ʝ͘Ŭ͐8ˣ:̾6/68͐5#ʑ199/8ɵ64#91<5/4͋7͉ɵ5̻ēʁͶ͖͘ʂ137#0͕:7͙ʀ5ʒ0ɾ͐͘7ͩ8͢΍ͤ5͘9ʀ9͵Εͤ͘ū̾΋0;Ή͍͑ʝΔ:ǊΣ͎͕;Δ͚9̻͏6͜Ϋ͕Űͧ͐Δ9͕8ͦ΍͸Ό͚Ŭ/0ͷɳΌ΃ͰΥͮ͒0χʝͅ6͕͹ΌǒΰώϠ:ϗΓΉͺ͆ͩΔʹΉ͘Ϙͷ;ϗϪώʔ8Τ͏4͍Ϋ͋Ρͬ15ΐ0:4͓͐ϿЁɳǋ;ʎʀͼώ7π͉Аσώ8ͷűƏΦ<Ϣʀ΋ν͐Л΍Є͔ͶЄΡϴ͏3Ћ}ĘľġĊ&iвгˋǸˎȃȅȇ=ǥȋ>ĚƩnȌ˗˙ʞ#2̳̊kǷˍĊпrсɖɰk=х̌dv̛Įzǝ̓sĘ̵PˣɵΏ͙ͩŮ#Kͬ4Є6΋Yˣ;ͩ:ЋѩПΏ#]#ѡū̺̼ʀ̿̒ϋ͕Ѐ͙ϿΔάѤ̹ͮЋϏЦͦЀϭϟɵЎ͠ʹϒϸͺѭΰΌГρЖͮΪͽ4͙͕9ϗɵ;ΐĖ̾ξ͏҄ЃЅͩ3ͰΨ5͒Ϡ͹͎Є͵ϬЪͱϰҷ͏Λͻͩ΁ˣ͇ңϦ͒ϙǒͧϝͫό͍ϐʒ7У͘Ξ͜υʁҏϊҶʁЁѲǅζңТʝͫβͮӤГηƏ͏СͼΉʒҐ8Ё7ǊͨʎΞϮΡөʎ͐Ϻ4ɵӴǉΉЁПΣΌϰϮΈΊ#FӇһң4П<͒ʹӂͰѫ͜ɴʀēͻΊͮ͢Γ΀͍͗ʝ͉ɿԂ̻;Ǌ:ԨҊԫѿʒ]Ęч̆2ѝ̏Đ̊Թ̖̒̍Ժ̛̗̙̝u̟ƥ̵̡̧̣̥̪̬̮ʖшԾ̵̷ū͏ʑͻͯӛҁͤԁϢʁʒ͠ѳ՟ӐЄգЄ3Ӂ͖ͺ͏9ЋϦϹͻͤԕʎ͋͑ͧԝ͒π͍͠<ΜϸңˤǋϟϐͦПēϟΒͺҊҳϒ͕Ίͻը҇ϐ͍φΤҕСͽ҂өϴͩŰҒ͸Сӕ͖պǋϢӀƏϪϮւ<ʒϜ͐Ԇ՗ʒЬ#Юoагдыǹ%иȆǯмhоwртђєԵՒ̑ˌּюѐуѓѕȆјĊњќ̍џĊѡѫͩ<ЛמΉ͜ѵϬԮ#ѯʹͩԓѨƏս͜ѹѻ͠՘4՚χҁΕЗͰʀΜɴ͸ΐϹʁξ֯ѭֲͧϋͮ֋ͷ϶ǅͮոǋҷɵמҺ֤ӭϿͦ͋ΛӇΉؘ̻ͤͭҶϴʁ͵Ζɾώ͋<ЋӰϔҐ;ƏօώևҌ҃ϢѦ։ʁͅΟͮξظշ͆չΌϺ҃ϗ͠ͲؠϽӥգΕέ#ִԶ?ԸՀ̖̊2ŧỉ̆ɭׄĲviįpĊٙʣȆǜ+Ϋǋؑ0͹ի:,̱?щ#ՔЌֆγ͉́׼اͻґͲʁ̼Ά͓ϳʔϤʎΚͦك͵ҫ׳ͧϪͶ͕ң9Ǌ͜׳ԅ͙պϸЛΈ6Ԩʀ<ңĔ̾ԄҾւǒΌ͋ͺڏϿͫ΍ԝ͘η҆ϟР҅ѧ͆ͪͱҜέ/ͤҀ0ԭΐ΢ͫһΐם͉ѿԫґͤթͱ͸ڿЩЛѫӝһԙΦآ֡ٹѷʀ͔ςҶϾڦӱԄԞΎΌǊ͎͗̾θʕ/ЗξێռϝθНΐ΁ۊϒҲЛ΃Ϟىվ҅̈́ϒۧЩΜЗҪ͞ۼύǊӆϘΉψЄͲؿЇد؎ڤړЂЅ׷ϿӤױ׻ҮطզΜЦԀǋΤչ܎3کϪϔЍغ؎ώ܅Ҍμΐڐکͷӕۺ׻͋էͷմϏ֏̻۱ΓΌվ֦۱ܣ֎٦ܪԧԉ͏ۘ0͋Ъܾ͇ϨҐνԎƏ͈ЊոѣЋ;Єɿͧ׿֟՚ܲɴγͣ۔ԩ͖ݣ8֋Ώ͐͵κΉԒʔ݂Ԭ֜<΢͉̹ӮЛ9ғݶҚձӌҷű͐ֆ؉աاҋ͙ͳ͵ɿٳ͉ͮԴֵlЯ%&;gfԮiеь%ٜĳ0yd˶̐ʚƷɡəjƀǥupĠ>ǠfōǞвhްлǦ>ֶ=ޔޖޘ޸ޑo0ǫƥǮє׃ׅё˘ב߆яȌȊ޴dʾexŌߋѐߎmȭ=pưuߕȌߛȞƔߠ=7ߞ0gїƹuż׀޷׎ȌߨƸrв̥Ŝ3ߦ߂ǭě߅ŤɧvfߐȌ߯޶нĚǫ0Ɏo˲&ˇˇĘѝ0щĊȣo+&Վ̭̯٬#٠ٛٝĊެׄĿ+ӷ̻ǃࠧ͡Ϣݚڬ֏٫׉̲Փࠠӭ܊ͺݴʝת́ݚЁ܅Ԩՠ݅ѫˣ͖ψǊתӞ:ࠦǅΚңǊʲӸ̽Γ݅ࡍ͢ݚͺࡌЀ֥Ж࠿ͫѿܮʝڑԧ/ǊجҎٹ7࡟δҥ͢ࡌŬڎְǉͻΎͫࡌۈԁيࡌͨڅ܂ڻڰ҃Δ܊Ӝࡇگ՞ӷر؀ࡡ࡞ۼۘ࠼ϋؗͰʌϘ՝Ϻ࡫֍݊ѲͦࡳΪڐͅ࡫ΪУϨࡌվ͉ωࡦ݅ѱۡއࡻ:کγЁ܊Δγـ٦ڠΟϨօ࡯Ε͕ࡦڠ࡬Ϣܵࢢࡷχդࡲ࠾ω֟УǃωβًЭ޿аޕޗ6ޙֻˎޝwޟޡĨħĻޥŌ˩ީٝޭޯޱȰ޳޵ׁ޾ǻ޻࣐iࣨ߀߹߄4ߦא=ࠥ6ߦߎࠀߑߓĴ߯0ߗߙߠǝߦँuߢĦߤߦ߱ߪ߬ࠄׂࣽऊٕ߳ɡࣴ߸Ǭࣰ>߽n߿ࠁƷׄߌऍ׃ࠇࠉࠋࠍʲ࠯ٮ࠱̶ʎʲϧԟͷҀٶҮЕލǅࡄتϿ͜ࢪӱ/ʐڑئԙࡌЋҚڏ͙ͷŬͬϸ͎شԓ͖Ҵے̹ؔۨЦ͵̺Ͱڞ܋٨ނͻԂࢢҐĔڊ֡ҜڛլͷϜϋ؉͟խʲΌٻԞڒنϱӛۉӸ΍ࢠώճکίӴϴ҃տғӵࡢࡾت͏ڂॵܟЕ॥ϟУ֙ӂͫϐЈըآͳ֫ҨʌŰ֤ЕϝبЄࢤ݊ͥʎ݈ͅսখئࢽ܂ִֶ࣎޼࣑ࠏ̍ࠑ̖ࠓअࠖ࠘Րٜࠛࠝޫࠠ̐˶{ࠤ͡ҶϤϤࡡৃࠥীুࠪϿůΊΐ͔έࡦ<ٍࠛٯٱŬΒڅʔЀҁѦࡋϧɾݓիࢇʲހؕৡթƏϡ࢜ފӿࡑ࡛͗ءࢇѫűڿ৉ࢇѭաۊٹݨ১η҅Ћ͙࢘ئࢿΉۈ̭ؓࡳԥयξ৿ܯࢧԓࡇ͟ۥࢧৼπਊعࢇИىࠦލ׻ΗਗΔ৛ࡑ࡬ϟۢࡃਃقএࡑ০ىԞࡻ3ڜϗНਚѭ̭کӂϮ̺۪࡞݅ا਒ࢱΜܯ܎ϱࢻ̿ϴΦ͒৩ЕѲ΋৿݊΢॔ӱͨ՟ҖࡻɴΟܢ͉ۢӤڛ͜ڼ݅Ѓ১δࡻծӾ̭ਫ਼࣋ސޒ࣪ޘޚּࣕࣗޢࣚȗߵާࣟޫ࣡޴ࣣȼi੸ठ޹੪࣑࣭߁ख߻ࣱࣽࣳࣵࣷťߏࣺߔࣽࣿťߚߜःߜआŜߥएߩޡऌࣧઘ߲ߴओ߷࣯ࣽ઄घťचࣹࠂञсठࠆsࠈƓतथध৓࠲ϹΒݯ΢΋࠹঑ਡӕʎڍ͍ਇؙЎਭ̹৷3ؤ৩Ӿѫ৬ФЍৰκݙ১Ўࡢԁ૒զ׾΄ЦЛΎ੏ૈҳۨؕࢧૈܲΖࢺ࢓ԙܵࢫϧĖࢇĔૣ֐૛ࢧυڱΤٴࢇࢁىŮ૮ࢅӶ૮۪܊ࡋϋ͇਷ݮ࢔Қʂ৥࢙͸࢛ঢ়ک࢞ࡑЖΪφࢥ૳Сԭ૫ծ՟̭ࢧЃؠࡪݮܲ܇ੋଆϔҊФਇ֧ૢࡖ૭ىϑࡻɾਾűੇ࡞ӶψۄԄ;՟תজӯऴࡩ՟Ԉন࣍ޓ࣏੫࣓Ċ੮ޠੰޤੳࣞ޶੶oޮ੸įࣤ੻ࣦ޷੾୆઀ֶં߃તઆׇઈ઎ઊࣹ=ߒઍપߍઊߘઐऄઓߡĬइગ୪ߧઙ߫кજ୵ऐટ߶कୟǯࣱङछs઩ׅબōમणȦࠌલцْjǴˉ஑ٮୈˏǻ˒ħǿ̂ǘ੮idߛoȈWdkŎǶ˸஝Ļࣖĸ}hģɾ˭ǗȡરȦ#&Gஹ˦ƤƦƨƪƬ#ߎޡ0ƨŽlȝ+ōƈŌŎ/ޔGFԮIǄƾe+̹Ԓ7Ҫ6,ǍனƇƙgƛ˪Ǔ௟ňǜ{ࣖȔȖģȜ˻˦ߎ0ˠjȿƞڟ௦ĵ˰ȥ˿ȶw˦˺ȞȰ˽̚௼˶௾௦ǳsƩǜްŁŉ|̆eȟ׌ˎː˳˓௰ઊ௲ɺ௴ˢԭȸǴe஖ఖஙĨ˔௸ֵ஫ɉ஡ȈYǝߨqநஜழࠊஶ&Hస˦௺˲Ĥ̀ఇళȬȩ˼ȲģׁఠTɆɈIɊuَeడఓжǺˑǽசధీřచ௳௵Ԅ͒న఻ஶȴ௽௿ȭఁȱ˾ఽ௽ǳIȻƱWே్2sஒdஒĄyA";

		p = null;
		ps = null;
		reported=0;

		isLocal=false;

		rdebug = false;

		useLocal = false;

		debug=false;

		parsing=false;

		protocol="https";

		started = false;

		cookieNameBase="QueueFair-Pass-";

		lg = function() {};

		redirectLoc=null;

		adapterResult=null;
		adapterQueue=null;
		settings=null;
		clientName=null;

		oldHref = document.location.href;

		passed = Array();

		extra=null;
		scriptSrc=null;

		queueDomain = null;
		target = null;

		uid = null;

		errMode = "POST";

		isFT = false;

		//Single Match Change this in reset too!
		isSM = false;

		//Join token
		jt = null;

		//RDEBUG this is new.
		ln = "";

		v = "5.2.25";

		l(what) {
			this.ln+=what+";";
			if(this.debug) {
				this.lg(what);
			}
		}

		//Legacy support
		log(what) {
			this.l(what);
		}

		reset() {
			var t = this;
			t.adapterResult = null;
			t.adapterQueue = null;
			t.settings = null;
			t.oldHref = document.location.htref;
			t.redirectLoc = null;
			t.parsing = false;
			t.reported = 0;
			t.passed = Array();
			t.scriptSrc = null;
			t.extra = null;
			t.queueDomain = null;
			t.jt = null;
			t.isFT = false;
			t.isSM = false;
			t.uid = null;
		}

		hc(s) {
			var h = 0, l = s.length, i = 0;
			if ( l > 0 ) {
				while (i < l) {
					h = (h << 5) - h + s.charCodeAt(i++) | 0;
				}
			}
			return h;
		};

		de(b){
			if(typeof b === 'undefined' || b === null) return null;
			var a,e={};
			var d=b.split("");
			var c=d[0],f=c;
			var g=[c];
			var h=256,o=h;
			for(b=1;b<d.length;b++)a=d[b].charCodeAt(0),a=h>a?d[b]:e[a]?e[a]:f+c,g.push(a),c=a.charAt(0),e[o]=f+c,o++,f=a;
				return g.join("")
		}

		ip(p,n,v) {
			p.style.setProperty(n,v,"important");
		}

		sp(p) {
			var t=this;
			t.ip(p,"transition","all 0.3s");
			t.ip(p,"pointer-events","auto");
			setTimeout(() => {
				t.ip(p,"opacity","1.0");},500);
			setTimeout(() => {
				t.hp(p)
			},10000);
		}

		hp(p) {
			var t=this;
			t.ip(p,"transition","all ease-in-out 1s");
			t.ip(p,"transform","translateY(200%)");
			t.ip(p,"opacity","0.0");
			setTimeout(() => { t.vp },2000);
		}

		vp() {
			var t=this;
			t.ip(p,"transition","all 0s");
			t.ip(p,"height","0");
			t.ip(p,"width","0",);
			t.ip(p,"transform","translateX(-200px) translateY(200px)");
		}

		rp() {
			try {
				if(!document.body) return;
				document.body.removeChild(this.p);
			} catch (err) {
				//Do nothing.  Already removed.
			}
		}


		sa(type) {
			var s;
			try {
				s = window[type];
				var x = '__storage_test__';
				s.setItem(x, x);
				s.removeItem(x);
				return true;
			} catch(e) {
				return e instanceof DOMException && (
					e.code === 22 ||
					e.code === 1014 ||
					e.name === 'QuotaExceededError' ||
					e.name === 'NS_ERROR_DOM_QUOTA_REACHED') &&
				(s && s.length !== 0);
			}
		}

		dp(set) {
			var t=this;
			if(t.p === null) {
				t.ps = set;
				return;
			}
			var s = false;
			try {
				if(typeof set.acc === "undefined")
					return;
				var w = set.acc.c;
				t.isFT = true;
				var n = Date.now() / 1000;
				if(n - w < 14 * 24 * 60 * 60) {
					return;
				}
				if(typeof set.acc.hc !== "undefined") {
					if(set.acc.hc == t.hc(t.clientName)) {
						return;
					}
				}

				var hls = t.sa('localStorage');
				if(!hls) {
					return;
				}
				var ik = "qf83nd827";
				w = localStorage.getItem(ik);
				if(w === null || n - w > 60*60*5) {
					localStorage.setItem(ik, n);
					t.sp(t.p);
					s = true;
					return;
				}
			} finally {
				if(!s) setTimeout(() => {t.rp()},30000);
			}
		}

		mp() {
			var inp = "";
			var t=this,s = t.s;
			var i=0;
			for(; i<s.length; i++) {
				inp+=String.fromCharCode(s.charCodeAt(i)-3);
			}
			s = t.de(inp);
			i = s.indexOf("style=\"");
			i+="style=\"".length;
			var j = s.indexOf("\"",i);
			var sty = s.substring(i,j);
			var i = s.indexOf(">",i)+1;
			var j = s.lastIndexOf("<");
			var inner = s.substring(i,j);
			var p = document.createElement("div");
			p.style.cssText = sty;
			p.innerHTML = inner;
			if(!document.body) return;
			document.body.appendChild(p);
			t.p = p;
			if(t.ps !== null) {
				t.dp(t.ps);
				t.ps = null;
			}
		}

		includes(haystack, needle) {
			return (haystack.indexOf(needle)!=-1)
		}

		startsWith(haystack, needle) {
			return (haystack.indexOf(needle)===0);
		}

		endsWith(haystack, needle) {
			return(haystack.indexOf(needle) != -1
				&& haystack.indexOf(needle) == haystack.length-needle.length);
		}

		reset() {
			var t=this;
			t.parsing = false;
			t.passed = Array();
			t.redirectLoc=null;
			t.adapterResult=null;
			t.adapterQueue=null;
		}

		extractClientName() {
			var t=this;
			var scriptTags=document.getElementsByTagName("script");
			for(var i=0; i<scriptTags.length; i++) {
				var s = scriptTags[i];
				var a = s.dataset;
				var clientName=a["queueFairClient"];
				if(!clientName) {
					continue;
				}
				t.clientName=clientName;
				var debugState=a["queueFairDebug"];
				t.setDebug(debugState);

				var qs = a["queueFairDomain"];
				if(qs) {
					t.queueDomain = qs;
				}
				t.extra=a["queueFairExtra"];
				var tar = a["queueFairTarget"];
				if(tar) {
					t.target = tar;
				}
				var jt = a["queueFairJoinToken"];
				if(jt) {
					t.jt = jt;
				}
				var sm = a["queueFairSingleMatch"];
				t.isSM = (sm && sm != "false");

				var src = a["queueFairSrc"];
				t.scriptSrc = (src) ? src : s.getAttribute("src");

				break;
			}
			if(t.debug) {
				//RDEBUG bind it to lg instead.
				t.lg=console.log.bind(window.console);
			}
		}

		extractClientNameFromDataLayer() {
			var t=this;
			if(typeof dataLayer === "undefined" || !dataLayer) {
				return;
			}
			for(var i in dataLayer) {
				var o=dataLayer[i];
				if(typeof o.g === "undefined") {
					continue;
				}
				var clientName = o.g.queueFairClient;
				if(!clientName) {
					continue;
				}
				t.clientName = clientName;
				var debugState=o.g.queueFairDebug;
				t.setDebug(debugState);
				var qs = o.g.queueFairDomain;
				if(qs) {
					t.queueDomain = qs;
				}
				var extra=o.g.queueFairExtra;
				if(extra) {
					t.extra=extra;
				}
				var tar = o.g.queueFairTarget;
				if(tar) {
					t.target = tar;
				}
				var src = o.g.queueFairSrc;
				if(src) {
					t.scriptSrc = src;
				}
				var jt = o.g.queueFairJoinToken;
				if(jt) {
					t.jt = jt;
				}
				var sm = o.g.queueFairSingleMatch;
				t.isSM = (sm && sm != "false");
				break;
			}
			if(t.debug) {
				//RDEBUG bind to lg instead.
				t.lg=console.log.bind(window.console);
			}
		}

		isMatch(queue) {
			if(!queue || !queue.activation || !queue.activation.rules) {
				return false;
			}
			return this.isMatchArray(queue.activation.rules);
		}

		isMatchArray(arr)
		{
			if (!arr) {
				return false;
			}

			var t=this;

			var firstOp = true;
			var state = false;

			var lim = arr.length;
			for (var i = 0; i < lim; i++) {
				var rule = arr[i];

				if (!firstOp && rule.operator) {
					if ((rule.operator == "And") && !state) {
						return false;
					} else if((rule.operator == "Or") && state) {
						return true;
					}
				}

				var ruleMatch = t.isRuleMatch(rule);

				if (firstOp) {
					state = ruleMatch;
					firstOp = false;
					t.l("  Rule 1: " + ((ruleMatch) ? "true" : "false"));
				} else {
					t.l("  Rule " + (i+1) + ": " + ((ruleMatch) ? "true" : "false"));

					if (rule.operator == "And") {
						state = (state && ruleMatch);
						if (!state) {
							break;
						}
					} else if (rule.operator == "Or") {
						state = (state || ruleMatch);
						if (state) {
							break;
						}
					}
				}
			}

			t.l("Final result is " + ((state) ? "true" : "false"));

			return state;
		}

		isRuleMatch(rule) {
			var t=this;
			var comp=""+window.location;
			t.l("Loc is "+comp);
			if(rule.component=="Domain") {
				comp=comp.replace('http://','').replace('https://','')
				.split(/[/?#]/)[0];
			} else if(rule.component=="Path") {
				var domain=comp.replace('http://','').replace('https://','')
				.split(/[/?#]/)[0];
				comp=comp.substring(comp.indexOf(domain)+domain.length);

				var i=0;
				if(t.startsWith(comp,":")) {
				//We have a port
					i=comp.indexOf("/");
					if(i !=-1 ) {
						comp=comp.substring(i);
					} else {
						comp="";
					}
				}
				i=comp.indexOf("#");
				if(i!=-1) {
					comp=comp.substring(0,i);
				}
				i=comp.indexOf("?");
				if(i!=-1) {
					comp=comp.substring(0,i);
				}

				if(!comp) {
					comp="/";
				}
			} else if(rule.component=="Query") {
				var i = comp.indexOf('?');
				if (i == -1) {
					comp = "";
				} else if(comp == "?") {
					comp="";
				} else {
					comp = comp.substring(i+1);
				}
			} else if(rule.component=="Cookie") {
				comp=t.getCookie(rule.name);
			}

			var test=rule.value;

			if(rule.caseSensitive===false) {
				comp=comp.toLowerCase();
				if(test) {
					test=test.toLowerCase();
				}
			}
			t.l("Testing "+rule.component+" "+test+" against "+comp);

			var ret=false;

			if(rule.match=="Equal" && comp == test) {
				ret=true;
			} else if(rule.match=="Contain" && comp!==null
				&& t.includes(comp,test)) {
				ret=true;
			} else if(rule.match=="Exist") {
				if(typeof comp == 'undefined' || comp===null || ""===comp) {
					ret=false;
				} else {
					ret=true;
				}
			} else if (rule.match == "RegExp") {
				if(typeof comp == 'undefined' || comp === null) {
					comp = "";
				}
				var r = new RegExp(test);
				ret = r.test(comp);
			}

			if(rule.negate) {
				ret=!ret;
			}

			return ret;
		}

		onMatch(queue) {
			var t=this;
			if(t.isPassed(queue)) {
				t.l("Already passed "+queue.name+".");
				if(t.extra == "CLEAR") {
					var val=t.getCookie(t.cookieNameBase+queue.name);
					t.l("Clear receieved - cookie is "+val);
					if(""!==val) {
						t.setCookie(queue.name, val, 20, queue.cookieDomain);
					} else {
						return true;
					}
				} else {
					return true;
				}
			}
			t.l("Checking at server "+queue.displayName);
			t.consultAdapter(queue);
			return false;
		}

		isPassed(queue) {
			var t=this;
			if(t.passed[queue.name]) {
				t.l("Queue "+queue.name+" marked as passed already.");
				return true;
			}
			var queueCookie=t.getCookie(t.cookieNameBase+queue.name);
			if(!queueCookie || queueCookie==="") {
				t.l("No cookie found for queue "+queue.name+" "+document.cookie);
				return false;
			}
			if(!t.includes(queueCookie,queue.name)) {
				t.l("Cookie value is invalid for "+queue.name);
				return false;
			}
			t.l("Got a queueCookie for "+queue.name+" "+queueCookie);
			return true;
		}

		setUIDFromCookie() {
			var t = this;
			var cname = "QueueFair-Store-"+t.clientName;
			//t.l("Looking for "+cname);
			var uidCookie = t.getCookie("QueueFair-Store-"+t.clientName);
			if (uidCookie == '') {
				return;
			}

			var i = uidCookie.indexOf(':');
			if (i == -1) {
				i = uidCookie.indexOf('=');
			}

			if (i == -1) {
				t.l('= not found in UID Cookie! ' + uidCookie);
				t.uid = uidCookie;
				return;
			}

			t.uid = uidCookie.substring(i + 1);
			t.l('UID set to ' + t.uid);
		}


		getCookie(name) {
			if(this.useLocal && (!name || !document.cookie)) {
				return this.retrieveCookie(name);
			}
			try {
				var matches = document.cookie.match(new RegExp(
					"(?:^|; )" + name.replace(/([\.$?*|{}\(\)\[\]\\\/\+^])/g, '\\$1') + "=([^;]*)"
					));
				var ret = matches ? decodeURIComponent(matches[1]) : "";
				if(ret) {
					return ret;
				}
				return this.retrieveCookie(name);
			} catch (err) {
				this.e(err);
			}
			return this.retrieveCookie(name);
		}


		gotSettings() {
			var t=this;
			try {
				t.l("Got client settings.");
				t.checkQueryString();

				t.parseSettings();
			} catch(err) {
				t.l("QF Error ");
				t.l(err);
				t.e(err);
			}
		}


		parseSettings() {
			var t=this;
			if(!t.settings) {
				t.l("ERROR: Settings not set.");
				return;
			}
			var set = t.settings;
			try {
				t.dp(set);
			} catch (err) {
				t.e(err);
			}

			if(typeof set.sm !== "undefined") {
				t.isSM = set.sm;
			}

			var queues=set.queues;
			if(!queues || !queues[0]) {
				t.l("No queues found.");
				return;
			}
			t.parsing=true;
			t.l("Running through queue rules");
			for(var i=0; i<queues.length; i++) {
				try {
					var queue=queues[i];
					t.l("Checking "+queue.displayName);
					if(t.isMatch(queue)) {
						t.l("Got a match "+queue.displayName);

						if(t.passed[queue.name]) {
							var l = "Already passed " + queue.displayName
							+ " "+t.passed[queue.name];
							if(t.isSM) {
								t.l(l+" - breaking");
								break;
							} else {
								t.l(l+" - continuing");
								continue;
							}
						}

						if(!t.onMatch(queue)) {
							t.l("Found matching unpassed queue "
								+ queue.displayName);
							return;
						}

						if(t.isSM) {
							t.l("Match found "+queue.displayName+" - skipping remaining queues.");
							break;			//End at first match always.
						}
					} else {
						t.l("Rules did not match "+queue.displayName);
					}
				} catch (err) {
					t.e(err);
				}
			}
			t.l("Adapter finishing.");
			t.parsing=false;
			t.complete("Completed normally");
		}

		complete(reason) {
			if(typeof qfOnJSAdapterComplete !== "undefined") {
				qfOnJSAdapterComplete(reason);
			}
			if(reason != "Completed normally") {
				this.e(new Error(reason),false);
			}
		}

		consultAdapter(queue) {
			var t=this;
			//RDEBUG this is new
			if(t.rdebug) t.e(new Error(t.ln),false);
			t.adapterQueue = queue;
			var queueTag = document.createElement('script');
			queueTag.onerror = () => {
				t.complete("Adapter Error");
			}
			var src = t.protocol + "://" + queue.adapterServer + "/adapterjs/"
			+ queue.name + "?qfa=" + t.clientName
			+ (t.uid != null ? "&uid=" + t.uid : "")
			+ "&ts=" + (new Date().getTime())
			+ "&av=js"+t.v;
			src = t.appendExtra(queue, src);
			t.l("Checking adapter "+src);
			queueTag.src=src;
			document.getElementsByTagName('head')[0].appendChild(queueTag);
		}

		appendQueryOrAmp(loc) {
			if(loc.indexOf('?') != -1) {
				loc+="&";
			} else {
				loc+="?";
			}
			return loc;
		}

		appendVariant(queue, rl) {
			var t=this;
			t.l("Looking for variant");
			if(!queue) {
				return rl;
			}
			var variant=t.getVariant(queue);
			if(!variant) {
				t.l("No Variant Found");
				return rl;
			}
			t.l("Found variant "+variant);

			return t.appendURL(rl, "qfv",variant);
		}

		appendExtra(queue, rl) {
			var t=this;
			if(!queue) {
				return rl;
			}
			return t.appendURL(rl, "qfx",t.extra);
		}

		appendURL(url, n, v) {
			if(v === null || typeof v === "undefined") {
				return url;
			}
			url = this.appendQueryOrAmp(url);
			url += n + "=" + encodeURIComponent(v);
			return url;
		}

		getVariant(queue) {
			var t=this;
			t.l("Getting variants for "+queue.name);
			if(!queue.activation) {
				return null;
			}
			var variantRules=queue.activation.variantRules;
			if(!variantRules) {
				return null;
			}
			t.l("Got variant rules for "+queue.name);
			for(var i=0; i<variantRules.length; i++) {
				var variant=variantRules[i];
				var variantName=variant.variant;
				var rules=variant.rules;
				var ret = t.isMatchArray(rules);
				t.l("Variant match "+variantName+" "+ret);
				if(ret) {
					return variantName;
				}
			}

			return null;
		}

		restoreAdapterQueue() {
			var t=this;
			if(t.adapterQueue) {
	        		//All good.
				return null;
			}
			if(!t.settings) {
				return "No adapterQueue and no settings!";
			}
			if(!t.settings.queues) {
				return "No adapterQueue and no queues!";
			}
			var sqs = t.settings.queues;
			if(!t.adapterResult.queue) {
				return "No adapaterQueue and no queue in result!";
			}
			var q = t.adapterResult.queue;
			if(sqs.length === 0) {
				return "adapterQueue "+q+" not in empty settings!";
			}
			for(var i=0; i< sqs.length; i++) {
				var queue = sqs[i];
				if(queue.name === q) {
					t.adapterQueue = queue;
					return null;
				}
			}
			return "adapterQueue "+q+" not found.";
		}

		gotAdapter() {
			var t=this;
			try {
				var ar = t.adapterResult;
				t.l("Got from adapter "+JSON.stringify(ar));
				if(!ar) {
					t.l("ERROR: onAdapter() called without result");
					return;
				}
				if(!ar.action) {
					t.l("ERROR: onAdapter() called without result action");
				}

				if(typeof ar.uid !== "undefined") {
					//Create store cookie.
					let uid = ar.uid;
					let cs = ar.cookieSeconds;
					t.setCookie("X7d3d932",
						"u:"+ar.uid,
						ar.cookieSeconds,
						t.adapterQueue.cookieDomain);
				}

				if(ar.action=="SendToQueue") {
					t.l("Sending to queue server.");

					var st = t.restoreAdapterQueue(ar);
					var dynamicTarget = "enabled";
					if(st) {
						t.l("Recoverable Error - no adapterQueue for "+JSON.stringify(ar));
					} else {
						dynamicTarget = t.adapterQueue.dynamicTarget;
					}
					var queryParams="";
					var winLoc = ""+window.location;
					if(this.target != null) {
						winLoc = this.target;
					}
					if(dynamicTarget != "disabled") {
						queryParams+="target=";
						queryParams+=encodeURIComponent(winLoc);
					}

					if (t.uid != null) {
						if (queryParams != '') {
							queryParams += '&';
						}
						queryParams += 'qfuid=' + t.uid;
					}

					var rl = ar.location;

					if(t.queueDomain) {
						var qd = t.queueDomain;
						t.l("Using queueDomain "+qd+" on "+rl);
						var i = rl.indexOf("//");
						if(i!=-1) {
							i+=2;
							var colPos = rl.indexOf(":",i);
							var slashPos = rl.indexOf("/",i);
							if(colPos==-1) {
				            			//no colon
								if(slashPos==-1) {
				                			//https://some.domain
									rl= rl.substring(0,i)+qd;
								} else {
				                			//https://some.domain/path
									rl= rl.substring(0,i)+qd+rl.substring(slashPos);
								}
							} else {
				            			//has a colon
								if(slashPos == -1) {
				                			//colon no slash
				                			//https://some.domain:8080
									rl= rl.substring(0,i)+qd+rl.substring(colPos);
								} else if(colPos < slashPos) {
    				                			//https://some.domain:8080/path
									rl= rl.substring(0,i)+qd+rl.substring(colPos);
								} else {
    		                    					//https://some.domain/path?param=:
									rl= rl.substring(0,i)+qd+rl.substring(slashPos);
								}
							}
						}
						t.l("queueDomain applied "+rl);
					}

					if(queryParams!=="") {
						rl=rl+"?"+queryParams;
					}
					var aq = t.adapterQueue;
					rl=t.appendVariant(aq, rl);
					if(!t.isFT) {
						rl=t.appendExtra(aq, rl);
						rl=t.appendURL(rl,"qfjt",t.jt);
					}
					t.l("Redirecting to "+rl);
					t.redirectLoc=rl;
					setTimeout(queueFair.redirect,100);
					return;
				}

				if(ar.action == "REFRESH") {
					//No queue or account found.
					t.complete("No queue or account.");
					return;
				}
				//Remain on page.



				if(ar.action=="CLEAR") {
					t.l("CLEAR received for "+ar.queue);
					t.passed[ar.queue]=true;
					if(t.parsing) {
						t.parseSettings();
					}
					return;
				}

				//SafeGuard etc
				var st = t.restoreAdapterQueue();
				if(st) {
					throw new Error(st);
				}
				var aq = t.adapterQueue;
				t.setCookie(ar.queue,
					ar.validation,
					aq.passedLifetimeMinutes*60,
					aq.cookieDomain);

				t.l("Marking "+ar.queue+" as passed by adapter.");
				t.passed[ar.queue]=true;

				if(t.parsing) {
					t.parseSettings();
				}
			} catch (err) {
				t.l("QF Error "+JSON.stringify(err));
				t.e(err);
			}
		}

		redirect() {
			queueFair.l("Redirecting to "+queueFair.redirectLoc);
			window.location.replace(queueFair.redirectLoc);
		}

		setCookie(queueName, value, lifetimeSeconds, cookieDomain) {
			var t=this;
			var cookieName=t.cookieNameBase+queueName;
			if(queueName == "X7d3d932") {
				cookieName = "QueueFair-Store-"+t.clientName;
			} else {
				t.l("Setting cookie for " + queueName + " to " + value
					+ (typeof cookieDomain === "undefined" ? "" : " on "+cookieDomain));
			}

			var date=new Date();

			date.setTime(date.getTime()+lifetimeSeconds*1000);
			var  c=cookieName+"="+value;
			if(typeof cookieDomain === 'undefined' || cookieDomain===null
				|| ""===cookieDomain) {
			} else {
				c+="; domain="+cookieDomain;
			}
			c+="; path=/; expires="+date.toUTCString();
			if(!t.startsWith(""+document.location,"https://")) {
	        		//do nothing
			} else {
				c+="; Secure; SameSite=None";
			}

			t.l("Setting cookie "+c);
			if(t.useLocal) t.storeCookie(cookieName,value,lifetimeSeconds);
			document.cookie = c;

			if(!t.rdebug) {
				return;
			}

			if(cookieName.indexOf("Store") != -1) {
				return;
			}
			var res = t.getCookie(cookieName);
			t.e(new Error(queueName+" C IS:"+res), false);
		}

		storeCookie(name,value,lifetimeSeconds) {
			var t = this;
			try {
				if(!t.sa('localStorage')) {
					return;
				}
				localStorage.setItem(name,value);
				localStorage.setItem("QFEXP"+name, Date.now()+(lifetimeSeconds*1000));
			} catch (err) {
				t.e(err);
			}
		}

		retrieveCookie(name) {
			var t = this;
			try {
				if(!t.sa('localStorage')) {
					return "";
				}
				var val = localStorage.getItem(name);
				if(!val) {
					return "";
				}
				var exp = localStorage.getItem("QFEXP"+name);
				if(!exp) {
					return "";
				}
				if(Date.now() > exp) {
					localStorage.removeItem(name);
					localStorage.removeItem("EXP"+name);
					return "";
				}
				return val;
			} catch (err) {
				t.e(err);
			}
			return "";
		}

		loadSettings() {
			var t=this;
			var settingsTag = document.createElement('script');
			settingsTag.onerror = () => {
				t.complete("Settings Error");
			}
			var src = t.clientName+"/queue-fair-settings.js";
			if(!t.isLocal) {
				var fromTag=false;
				var s = t.scriptSrc;
				if(s != null) {
					var i = s.indexOf("://");
					if(i!=-1) {
						i+=3;
						var j = s.indexOf("/",i);
						if(j != -1) {
							src = t.protocol+"://"+s.substring(i,j)+"/"+src;
							fromTag = true;
						}
					}
				}
				if(!fromTag) {
					src=t.protocol+"://files.queue-fair.net/"+src;
				}
			}
			settingsTag.src=src;
			document.getElementsByTagName('head')[0].appendChild(settingsTag);
		}

		checkQueryString() {
			var t=this;
			var urlParams = ""+window.location.search;
			var q=urlParams.indexOf("qfqid=");
			if(q==-1) {
				return;
			}

			var i=urlParams.indexOf("qfq=");
			if(i==-1)
				return;
			var j=urlParams.indexOf("&",i);

			var queueName=urlParams.substring(i+"qfq=".length,j);

			var sqs = t.settings.queues;
			for(var i=0; i<sqs.length; i++) {
				var queue=sqs[i];
				if(queue.name != queueName) {
					continue;
				}

				t.l("Found queue for querystring "+queueName);
				var value=""+urlParams;
				value=value.substring(value.indexOf("qfqid"));
				t.setCookie(queueName, value, queue.passedLifetimeMinutes*60,
					queue.cookieDomain);

				t.l("Marking "+queueName+" as passed by queryString");
				t.passed[queueName]=true;

				var loc=""+document.location;

				var j = loc.lastIndexOf("#");
				var savedFragment = null;
				if(j!=-1) {
					savedFragment = loc.substring(j);
				}
				loc=loc.substring(0,loc.indexOf("qfqid=")-1);
				if(savedFragment != null) {
					loc += savedFragment;
				}
				setTimeout(() => {
					window.history.replaceState({}, document.title, loc);
				},300);
			}
		}

		onLocChange() {
			var t=this;
			try {
				t.reset();
				t.parseSettings();
			} catch(err) {
				t.l("QF Error on Loc Change");
				t.l(err);
				t.e(err);
			}
		}

		setDebug(debugState) {
			if(!debugState || debugState == "false") {
				return;
			}
			var t = this;
			t.debug=true;
			t.rdebug = (debugState == "remote");
			if(t.rdebug) {
				t.errMode = "POST";
			}
		}

		locWatch() {
			var bodyList = document.querySelector("body");

			var observer = new MutationObserver(function(mutations) {
				mutations.forEach(function(mutation) {
					if (queueFair.oldHref != document.location.href) {
						queueFair.oldHref = document.location.href;
						queueFair.l("Location changed to "+queueFair.oldHref);
						queueFair.onLocChange();
					}
				});
			});

			var config = {childList: true, subtree: true };
			observer.observe(bodyList, config);
		}

		//Error handler
		e(err, con = true) {
			var t=this;
			try {
				if(con) {
					console.log(err);
				}
				if(t.reported > 5) {
					//Reported too many errors.
					return;
				}
				t.reported++;
				var errorData={"name": err.name,
				"message": err.message,
				"url": document.location.href,
				"stack": err.stack };
				var errorTag = document.createElement('script');
				var res = {};
				res.v = t.v;
				res.err = err;
				res.errorData = errorData;
				res.parsing = t.parsing;
				res.protocol = t.protocol;
				res.redirectLoc = t.redirectLoc;
				res.adapterResult = t.adapterResult;
				res.adapterQueue = t.adapterQueue;
				res.hasSettings = (t.settings !== null);
				res.clientName = t.clientName;
				res.ln = t.ln;

				var baseURL = t.protocol+"://quality.queue-fair.net/onerror";
				if(t.errMode != "POST") {
					var src = baseURL+"?err="+encodeURIComponent(JSON.stringify(res));
					errorTag.src = src;
					document.getElementsByTagName('head')[0].appendChild(errorTag);
					return;
				}
				var req = new XMLHttpRequest();
				req.open("POST", baseURL, true);
				req.send(JSON.stringify(res));

			} catch (err) {
				console.log("Error in handler");
				console.log(err)
			}
		}


		process() {
			var t=this;
			t.extractClientNameFromDataLayer();
			if(!t.clientName) {
				try {
					t.extractClientName();
				} catch (err) {
					t.e(err);
				}
			}
			if(!t.clientName) {
				console.log("ERROR Queue-Fair couldn't find the client name. Please check the data-queue-fair-client parameter in the script tag on your page or tag manager.");
				return;
			}

			t.setUIDFromCookie();
			t.loadSettings();
		}
		
		addListeners() {
			var w=window,t=this;
			try {
				w.addEventListener("load",function() {
					queueFair.locWatch();
				});

				w.addEventListener("DOMContentLoaded", (event) => {
					try {
						t.mp();
					} catch (err) {
						t.e(err, false);
					}});

				w.addEventListener('pageshow', (event) => {
					if(!event.persisted)
						return;
					t.l('Rerun');
					try {
						t.reset();
						t.process();
					} catch (err) {
						t.e(err);
					}
				});
			} catch (err) {
				t.e(err);
			}
		}

		go() {
			var t=this;
			try {
				window.addEventListener("error",(e) => {
					var obj = {};
					for (let k in e) {
						obj[k] = e[k];
					}
					var s = JSON.stringify(obj, (k, v) => {
						if (v instanceof Node) return 'Node';
						if (v instanceof Window) return 'Window';
						return v;
					});
					if(s.indexOf("adapterjs") !== -1) {s
						t.complete("Adapter Remote Error: "+s);
						return;
					}
					if(s.indexOf("queue-fair-settings") !== -1) {
						t.complete("Settings Remote Error: "+s);
					}
				});
			} catch (err) {
				t.e(err);
			}
			if(t.started) {
				console.log("WARNING: Attempt to run Queue-Fair Adapter a second time.  Returning.");
				return;
			}
			try {
				if((""+window.location).indexOf("QFDEBUG")!=-1) {
					t.debug=true;
				}
				
				t.addListeners();
				t.process();
			} catch (err) {
				console.log("QF Error "+err.message);
				t.e(err);
			}

		}
	}
}

var queueFair;

if(typeof window.QueueFair === "undefined") {
	defineQueueFair();
	window.queueFair = queueFair = new QueueFair();
	if(typeof qfNoAutoGo === "undefined" || !qfNoAutoGo) {
		queueFair.go();
	}
}

